webpackJsonp([84],{2157:function(n,t,e){"use strict";function i(n){return o._57(0,[(n()(),o._31(0,0,null,null,13,"ion-item",[["class","item-title item item-block"],["text-wrap",""]],null,null,null,N.b,N.a)),o._30(1,1097728,null,3,W.a,[B.a,H.a,o.t,o.V,[2,G.a]],null,null),o._52(335544320,2,{contentLabel:0}),o._52(603979776,3,{_buttons:1}),o._52(603979776,4,{_icons:1}),o._30(5,16384,null,0,K.a,[],null,null),(n()(),o._55(-1,2,["\n                "])),(n()(),o._31(7,0,null,3,5,"ion-input",[["name","title"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,$.b,$.a)),o._30(8,671744,null,0,c.f,[[3,c.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),o._50(2048,null,c.m,null,[c.f]),o._30(10,16384,null,0,c.n,[c.m],null,null),o._30(11,5423104,null,0,J.a,[H.a,q.a,B.a,z.a,o.t,o.V,[2,Q.a],[2,W.a],[2,c.m],X.a],{type:[0,"type"],placeholder:[1,"placeholder"]},null),o._47(131072,Y.a,[Z.a,o.j]),(n()(),o._55(-1,2,["\n            "]))],function(n,t){n(t,8,0,"title");n(t,11,0,"text",o._56(t,11,1,o._44(t,12).transform("addon.mod_wiki.newpagetitle")))},function(n,t){n(t,7,0,o._44(t,10).ngClassUntouched,o._44(t,10).ngClassTouched,o._44(t,10).ngClassPristine,o._44(t,10).ngClassDirty,o._44(t,10).ngClassValid,o._44(t,10).ngClassInvalid,o._44(t,10).ngClassPending)})}function l(n){return o._57(0,[(n()(),o._31(0,0,null,null,11,"ion-item",[["class","addon-mod_wiki-wrongversionlock item item-block"],["text-center",""]],null,null,null,N.b,N.a)),o._30(1,1097728,null,3,W.a,[B.a,H.a,o.t,o.V,[2,G.a]],null,null),o._52(335544320,8,{contentLabel:0}),o._52(603979776,9,{_buttons:1}),o._52(603979776,10,{_icons:1}),o._30(5,16384,null,0,K.a,[],null,null),(n()(),o._55(-1,2,["\n                "])),(n()(),o._31(7,0,null,2,3,"ion-badge",[["color","danger"],["padding",""]],null,null,null,null,null)),o._30(8,16384,null,0,nn.a,[H.a,o.t,o.V],{color:[0,"color"]},null),(n()(),o._55(9,null,["",""])),o._47(131072,Y.a,[Z.a,o.j]),(n()(),o._55(-1,2,["\n            "]))],function(n,t){n(t,8,0,"danger")},function(n,t){n(t,9,0,o._56(t,9,0,o._44(t,10).transform("addon.mod_wiki.wrongversionlock")))})}function a(n){return o._57(0,[(n()(),o._31(0,0,null,null,23,"ion-header",[],null,null,null,null,null)),o._30(1,16384,null,0,tn.a,[H.a,o.t,o.V,[2,en.a]],null,null),(n()(),o._55(-1,null,["\n    "])),(n()(),o._31(3,0,null,null,19,"ion-navbar",[["class","toolbar"],["core-back-button",""]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,ln.b,ln.a)),o._30(4,49152,null,0,an.a,[z.a,[2,en.a],[2,on.a],H.a,o.t,o.V],null,null),o._30(5,212992,null,0,un.a,[an.a,q.a,Z.a,h.a],null,null),(n()(),o._55(-1,3,["\n        "])),(n()(),o._31(7,0,null,3,3,"ion-title",[],null,null,null,rn.b,rn.a)),o._30(8,49152,null,0,sn.a,[H.a,o.t,o.V,[2,dn.a],[2,an.a]],null,null),(n()(),o._31(9,16777216,null,0,1,"core-format-text",[["contextLevel","module"]],null,null,null,null,null)),o._30(10,540672,null,0,cn.a,[o.t,g.a,_.a,p.a,Z.a,q.a,hn.a,gn.a,fn.a,_n.a,pn.a,In.a,[2,on.a],[2,Q.a],[2,kn.a],mn.a,h.a,wn.a,vn.a,bn.a,o._11],{text:[0,"text"],contextLevel:[1,"contextLevel"],contextInstanceId:[2,"contextInstanceId"],courseId:[3,"courseId"]},null),(n()(),o._55(-1,3,["\n\n        "])),(n()(),o._31(12,0,null,2,9,"ion-buttons",[["end",""]],null,null,null,null,null)),o._30(13,16384,null,1,Pn.a,[H.a,o.t,o.V,[2,dn.a],[2,an.a]],null,null),o._52(603979776,1,{_buttons:1}),(n()(),o._55(-1,null,["\n            "])),(n()(),o._31(16,0,null,null,4,"button",[["clear",""],["ion-button",""]],[[1,"aria-label",0]],[[null,"click"]],function(n,t,e){var i=!0;if("click"===t){i=!1!==n.component.save()&&i}return i},yn.b,yn.a)),o._30(17,1097728,[[1,4]],0,Cn.a,[[8,""],H.a,o.t,o.V],{clear:[0,"clear"]},null),o._47(131072,Y.a,[Z.a,o.j]),(n()(),o._55(19,0,["\n                ","\n            "])),o._47(131072,Y.a,[Z.a,o.j]),(n()(),o._55(-1,null,["\n        "])),(n()(),o._55(-1,3,["\n    "])),(n()(),o._55(-1,null,["\n"])),(n()(),o._55(-1,null,["\n"])),(n()(),o._31(25,0,null,null,31,"ion-content",[],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,On.b,On.a)),o._30(26,4374528,null,0,Q.a,[H.a,q.a,X.a,o.t,o.V,z.a,Ln.a,o.M,[2,en.a],[2,on.a]],null,null),(n()(),o._55(-1,1,["\n    "])),(n()(),o._31(28,0,null,1,27,"core-loading",[],null,null,null,xn.b,xn.a)),o._30(29,638976,null,0,Vn.a,[Z.a,o.t,h.a,hn.a],{hideUntil:[0,"hideUntil"]},null),(n()(),o._55(-1,0,["\n        "])),(n()(),o._31(31,0,null,0,23,"form",[["ion-list",""],["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"submit"],[null,"reset"]],function(n,t,e){var i=!0;if("submit"===t){i=!1!==o._44(n,33).onSubmit(e)&&i}if("reset"===t){i=!1!==o._44(n,33).onReset()&&i}return i},null,null)),o._30(32,16384,null,0,c.w,[],null,null),o._30(33,540672,null,0,c.h,[[8,null],[8,null]],{form:[0,"form"]},null),o._50(2048,null,c.b,null,[c.h]),o._30(35,16384,null,0,c.o,[c.b],null,null),(n()(),o._55(-1,null,["\n            "])),(n()(),o._26(16777216,null,null,1,null,i)),o._30(38,16384,null,0,Dn.k,[o._11,o._6],{ngIf:[0,"ngIf"]},null),(n()(),o._55(-1,null,["\n\n            "])),(n()(),o._31(40,0,null,null,10,"ion-item",[["class","item item-block"]],null,null,null,N.b,N.a)),o._30(41,1097728,null,3,W.a,[B.a,H.a,o.t,o.V,[2,G.a]],null,null),o._52(335544320,5,{contentLabel:0}),o._52(603979776,6,{_buttons:1}),o._52(603979776,7,{_icons:1}),o._30(45,16384,null,0,K.a,[],null,null),(n()(),o._55(-1,2,["\n                "])),(n()(),o._31(47,0,null,3,2,"core-rich-text-editor",[["item-content",""],["name","wiki_page_content"]],null,null,null,Tn.b,Tn.a)),o._30(48,1228800,null,0,En.a,[_.a,gn.a,g.a,_n.a,[2,Q.a],o.t,h.a,hn.a,q.a],{placeholder:[0,"placeholder"],control:[1,"control"],name:[2,"name"],component:[3,"component"],componentId:[4,"componentId"]},null),o._47(131072,Y.a,[Z.a,o.j]),(n()(),o._55(-1,2,["\n            "])),(n()(),o._55(-1,null,["\n\n            "])),(n()(),o._26(16777216,null,null,1,null,l)),o._30(53,16384,null,0,Dn.k,[o._11,o._6],{ngIf:[0,"ngIf"]},null),(n()(),o._55(-1,null,["\n        "])),(n()(),o._55(-1,0,["\n    "])),(n()(),o._55(-1,1,["\n"])),(n()(),o._55(-1,null,["\n"]))],function(n,t){var e=t.component;n(t,5,0);n(t,10,0,e.title,"module",e.module.id,e.courseId);n(t,17,0,"");n(t,29,0,e.loaded);n(t,33,0,e.pageForm);n(t,38,0,e.canEditTitle);n(t,48,0,o._56(t,48,0,o._44(t,49).transform("core.content")),e.contentControl,"wiki_page_content",e.component,e.componentId);n(t,53,0,e.wrongVersionLock)},function(n,t){n(t,3,0,o._44(t,4)._hidden,o._44(t,4)._sbPadding);n(t,16,0,o._56(t,16,0,o._44(t,18).transform("core.save")));n(t,19,0,o._56(t,19,0,o._44(t,20).transform("core.save")));n(t,25,0,o._44(t,26).statusbarPadding,o._44(t,26)._hasRefresher);n(t,31,0,o._44(t,35).ngClassUntouched,o._44(t,35).ngClassTouched,o._44(t,35).ngClassPristine,o._44(t,35).ngClassDirty,o._44(t,35).ngClassValid,o._44(t,35).ngClassInvalid,o._44(t,35).ngClassPending)})}Object.defineProperty(t,"__esModule",{value:!0});var o=e(0),u=e(5),r=e(3),s=e(27),d=e(31),c=e(23),h=e(10),g=e(1),f=e(81),_=e(4),p=e(11),I=e(13),k=e(38),m=e(236),w=e(291),v=e(292),b=this&&this.__decorate||function(n,t,e,i){var l,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(n,t,e,i);else for(var u=n.length-1;u>=0;u--)(l=n[u])&&(o=(a<3?l(o):a>3?l(t,e,o):l(t,e))||o);return a>3&&o&&Object.defineProperty(t,e,o),o},P=this&&this.__metadata||function(n,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(n,t)},y=function(){function n(n,t,e,i,l,a,o,u,r,s,d,c,h,g){this.navCtrl=e,this.sitesProvider=i,this.syncProvider=l,this.domUtils=a,this.translate=o,this.courseProvider=u,this.eventsProvider=r,this.wikiProvider=s,this.wikiOffline=d,this.wikiSync=c,this.textUtils=h,this.courseHelper=g,this.component=m.a.COMPONENT,this.forceLeave=!1,this.isDestroyed=!1,this.module=n.get("module")||{},this.courseId=n.get("courseId"),this.subwikiId=n.get("subwikiId"),this.wikiId=n.get("wikiId"),this.pageId=n.get("pageId"),this.section=n.get("section"),this.groupId=n.get("groupId"),this.userId=n.get("userId");var f=n.get("pageTitle");f=f?f.replace(/\+/g," "):"",this.initialSubwikiId=this.subwikiId,this.componentId=this.module.id,this.canEditTitle=!f,this.title=f?this.translate.instant("addon.mod_wiki.editingpage",{$a:f}):this.translate.instant("addon.mod_wiki.newpagehdr"),this.blockId=this.wikiSync.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId),this.contentControl=t.control(""),this.pageForm=t.group({title:f}),this.pageForm.addControl("text",this.contentControl),this.syncProvider.blockOperation(this.component,this.blockId)}return n.prototype.ngOnInit=function(){var n=this;this.fetchWikiPageData().then(function(t){if(t&&n.blockId&&!n.isDestroyed){var e=n.wikiSync.getSubwikiBlockId(n.subwikiId,n.wikiId,n.userId,n.groupId);e!=n.blockId&&(n.syncProvider.unblockOperation(n.component,n.blockId),n.blockId=e,n.syncProvider.blockOperation(n.component,n.blockId))}}).finally(function(){n.loaded=!0})},n.prototype.fetchWikiPageData=function(){var n,t=this,e=!1;if(this.pageId)this.canEditTitle=!1,this.editing=!0,this.editOffline=!1,n=this.wikiProvider.getPageContents(this.pageId).then(function(n){return t.pageForm.controls.title.setValue(n.title),t.wikiId=n.wikiid,t.subwikiId=n.subwikiid,t.title=t.translate.instant("addon.mod_wiki.editingpage",{$a:n.title}),t.groupId=n.groupid,t.userId=n.userid,e=n.caneditpage,t.wikiSync.waitForSync(t.blockId)}).then(function(){return t.wikiProvider.getSubwikiFiles(t.wikiId,t.groupId,t.userId)}).then(function(n){return t.subwikiFiles=n,t.wikiProvider.getPageForEditing(t.pageId,t.section)}).then(function(n){var i=t.textUtils.replacePluginfileUrls(n.content,t.subwikiFiles);t.contentControl.setValue(i),t.originalContent=i,t.version=n.version,e&&(t.renewLockInterval=setInterval(function(){t.renewLock()},m.a.RENEW_LOCK_TIME))});else{var i=this.pageForm.controls.title.value;n=this.wikiSync.waitForSync(this.blockId),i?n=n.then(function(n){if(n){var e=n.created.find(function(n){return n.title==i});if(e&&e.pageId>0)return t.pageId=e.pageId,t.fetchWikiPageData()}return t.wikiOffline.getNewPage(i,t.subwikiId,t.wikiId,t.userId,t.groupId)}).then(function(n){t.contentControl.setValue(n.cachedcontent),t.originalContent=n.cachedcontent,t.editOffline=!0}).catch(function(){t.editOffline=!1}):this.editOffline=!1,n.then(function(){t.editing=!1,e=!!t.blockId})}return n.then(function(){return!0}).catch(function(n){return t.domUtils.showErrorModalDefault(n,"Error getting wiki data."),t.forceLeavePage(),!1}).finally(function(){e||(t.domUtils.showAlert(t.translate.instant("core.notice"),t.translate.instant("addon.mod_wiki.cannoteditpage")),t.forceLeavePage())})},n.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},n.prototype.goToNewOfflinePage=function(n){this.courseId&&(this.module.id||this.wikiId)?this.editOffline&&!this.previousViewPageIsDifferentOffline(n)||(this.pageParamsToLoad={module:this.module,courseId:this.courseId,pageId:null,pageTitle:n,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}):this.domUtils.showAlert(this.translate.instant("core.success"),this.translate.instant("core.datastoredoffline")),this.forceLeavePage()},n.prototype.gotoPage=function(n){var t=this;return this.retrieveModuleInfo(this.wikiId).then(function(){var e=!1;t.initialSubwikiId&&(!t.editing&&t.editOffline&&t.previousViewPageIsDifferentOffline(n)?e=!0:!t.editOffline&&t.previousViewIsDifferentPageOnline()&&(e=!0)),e&&(t.pageParamsToLoad={module:t.module,courseId:t.courseId,pageId:t.pageId,pageTitle:n,wikiId:t.wikiId,subwikiId:t.subwikiId,userId:t.userId,groupId:t.groupId}),t.forceLeavePage()}).catch(function(){t.forceLeavePage()})},n.prototype.hasDataChanged=function(){var n=this.pageForm.value;return!(this.originalContent==n.text||!this.editing&&!n.text&&!n.title)},n.prototype.ionViewCanLeave=function(){return!!this.forceLeave||(!this.hasDataChanged()||this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")))},n.prototype.ionViewDidLeave=function(){this.pageParamsToLoad&&this.navCtrl.push("AddonModWikiIndexPage",this.pageParamsToLoad)},n.prototype.previousViewIsDifferentPageOnline=function(){var n=this.navCtrl.getPrevious();return!this.editing||"AddonModWikiIndexPage"!=n.component.name||n.data.module.id!=this.module.id||n.data.pageId!=this.pageId},n.prototype.previousViewPageIsDifferentOffline=function(n){var t=this.navCtrl.getPrevious();if("AddonModWikiIndexPage"!=t.component.name||t.data.module.id!=this.module.id||t.data.wikiId!=this.wikiId||t.data.pageTitle!=n)return!0;var e=parseInt(t.data.subwikiId,10)||0;if(e>0&&this.subwikiId>0)return e!=this.subwikiId;var i=parseInt(t.data.userId,10)||0,l=parseInt(t.data.groupId,10)||0;return this.userId!=i||this.groupId!=l},n.prototype.save=function(){var n,t=this,e=this.pageForm.value,i=e.title,l=this.domUtils.showModalLoading("core.sending",!0),a=e.text;if(a=this.textUtils.restorePluginfileUrls(a,this.subwikiFiles),a=this.textUtils.formatHtmlLines(a),this.editing)n=this.wikiProvider.editPage(this.pageId,a,this.section).then(function(){return t.wikiProvider.invalidatePage(t.pageId).then(function(){return t.gotoPage(i)})});else{if(!i)return this.domUtils.showAlert(this.translate.instant("core.notice"),this.translate.instant("addon.mod_wiki.titleshouldnotbeempty")),void l.dismiss();n=(n=this.editOffline?Promise.resolve():this.wikiOffline.getNewPage(i,this.subwikiId,this.wikiId,this.userId,this.groupId).then(function(){return Promise.reject(t.translate.instant("addon.mod_wiki.pageexists"))},function(){})).then(function(){var n=t.wikiId||t.module&&t.module.instance;return t.wikiProvider.newPage(i,a,t.subwikiId,n,t.userId,t.groupId).then(function(e){if(e>0)return t.pageId=e,t.wikiProvider.getPageContents(t.pageId).then(function(e){var l=[];return n=parseInt(e.wikiid,10),t.subwikiId||l.push(t.wikiProvider.invalidateSubwikis(n)),t.subwikiId=parseInt(e.subwikiid,10),t.userId=parseInt(e.userid,10),t.groupId=parseInt(e.groupid,10),l.push(t.wikiProvider.invalidateSubwikiPages(n)),Promise.all(l).then(function(){return t.gotoPage(i)})}).finally(function(){t.eventsProvider.trigger(m.a.PAGE_CREATED_EVENT,{pageId:t.pageId,subwikiId:t.subwikiId,pageTitle:i},t.sitesProvider.getCurrentSiteId())});t.goToNewOfflinePage(i)})})}return n.catch(function(n){t.domUtils.showErrorModalDefault(n,"Error saving wiki data.")}).finally(function(){l.dismiss()})},n.prototype.renewLock=function(){var n=this;this.wikiProvider.getPageForEditing(this.pageId,this.section,!0).then(function(t){t.version&&n.version!=t.version&&(n.wrongVersionLock=!0)})},n.prototype.retrieveModuleInfo=function(n){var t=this;if(this.module.id&&this.courseId)return Promise.resolve();return(this.module.id?Promise.resolve(this.module):this.courseProvider.getModuleBasicInfoByInstance(n,"wiki")).then(function(e){if(t.module=e,t.componentId=t.module.id,!t.courseId&&t.module.course)t.courseId=t.module.course;else if(!t.courseId)return t.courseHelper.getModuleCourseIdByInstance(n,"wiki").then(function(n){t.courseId=n})})},n.prototype.ngOnDestroy=function(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&this.syncProvider.unblockOperation(this.component,this.blockId)},n=b([Object(o.m)({selector:"page-addon-mod-wiki-edit",templateUrl:"edit.html"}),P("design:paramtypes",[u.t,c.d,u.s,g.a,f.a,_.a,r.c,I.a,h.a,m.a,w.a,v.a,p.a,k.a])],n)}(),C=this&&this.__decorate||function(n,t,e,i){var l,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(n,t,e,i);else for(var u=n.length-1;u>=0;u--)(l=n[u])&&(o=(a<3?l(o):a>3?l(t,e,o):l(t,e))||o);return a>3&&o&&Object.defineProperty(t,e,o),o},O=function(){function n(){}return n=C([Object(o.I)({declarations:[y],imports:[s.a,d.a,u.l.forChild(y),r.b.forChild()]})],n)}(),L=e(1528),x=e(1529),V=e(1530),D=e(1531),T=e(1532),E=e(1533),U=e(1534),j=e(1535),F=e(1536),M=e(1537),S=e(1538),R=e(1539),A=e(1540),N=e(30),W=e(20),B=e(19),H=e(8),G=e(26),K=e(33),$=e(112),J=e(92),q=e(16),z=e(35),Q=e(29),X=e(34),Y=e(25),Z=e(17),nn=e(144),tn=e(375),en=e(39),ln=e(727),an=e(213),on=e(21),un=e(479),rn=e(728),sn=e(316),dn=e(250),cn=e(48),hn=e(2),gn=e(22),fn=e(6),_n=e(18),pn=e(9),In=e(15),kn=e(28),mn=e(44),wn=e(43),vn=e(32),bn=e(36),Pn=e(376),yn=e(45),Cn=e(41),On=e(182),Ln=e(109),xn=e(54),Vn=e(51),Dn=e(7),Tn=e(318),En=e(253),Un=e(70),jn=o._29({encapsulation:2,styles:[],data:{}}),Fn=o._27("page-addon-mod-wiki-edit",y,function(n){return o._57(0,[(n()(),o._31(0,0,null,null,1,"page-addon-mod-wiki-edit",[],null,null,null,a,jn)),o._30(1,245760,null,0,y,[Un.a,c.d,on.a,g.a,f.a,_.a,Z.a,I.a,h.a,m.a,w.a,v.a,p.a,k.a],null,null)],function(n,t){n(t,1,0)},null)},{},{},[]),Mn=e(371),Sn=e(372),Rn=e(374),An=e(373),Nn=e(478),Wn=e(726),Bn=e(108),Hn=e(273);e.d(t,"AddonModWikiEditPageModuleNgFactory",function(){return Gn});var Gn=o._28(O,[],function(n){return o._40([o._41(512,o.o,o._21,[[8,[L.a,x.a,V.a,D.a,T.a,E.a,U.a,j.a,F.a,M.a,S.a,R.a,A.a,Fn]],[3,o.o],o.K]),o._41(4608,Dn.m,Dn.l,[o.G,[2,Dn.w]]),o._41(4608,c.x,c.x,[]),o._41(4608,c.d,c.d,[]),o._41(4608,Mn.b,Mn.a,[]),o._41(4608,Sn.a,Sn.b,[]),o._41(4608,Rn.b,Rn.a,[]),o._41(4608,An.b,An.a,[]),o._41(4608,Z.a,Z.a,[Nn.a,Mn.b,Sn.a,Rn.b,An.b,Z.b,Z.c]),o._41(512,Dn.b,Dn.b,[]),o._41(512,c.v,c.v,[]),o._41(512,c.i,c.i,[]),o._41(512,c.s,c.s,[]),o._41(512,Wn.a,Wn.a,[]),o._41(512,r.b,r.b,[]),o._41(512,d.a,d.a,[]),o._41(512,Bn.a,Bn.a,[]),o._41(512,s.a,s.a,[]),o._41(512,Wn.b,Wn.b,[]),o._41(512,O,O,[]),o._41(256,Z.c,void 0,[]),o._41(256,Z.b,void 0,[]),o._41(256,Hn.a,y,[])])})}});