webpackJsonp([81],{2143:function(n,t,l){"use strict";function e(n){return a._57(0,[(n()(),a._31(0,0,null,null,19,"ion-item",[["class","item item-block"]],null,null,null,N.b,N.a)),a._30(1,1097728,null,3,B.a,[H.a,Y.a,a.t,a.V,[2,z.a]],null,null),a._52(335544320,5,{contentLabel:0}),a._52(603979776,6,{_buttons:1}),a._52(603979776,7,{_icons:1}),a._30(5,16384,null,0,G.a,[],null,null),(n()(),a._55(-1,2,["\n                "])),(n()(),a._31(7,0,null,1,4,"ion-label",[["stacked",""]],null,null,null,Q.b,Q.a)),a._30(8,4308992,null,0,W.a,[a.t,J.a,g.a,K.a],{coreMarkRequired:[0,"coreMarkRequired"]},null),a._30(9,16384,[[5,4]],0,X.a,[Y.a,a.t,a.V,[8,null],[8,""],[8,null],[8,null]],null,null),(n()(),a._55(10,0,["",""])),a._47(131072,Z.a,[J.a,a.j]),(n()(),a._55(-1,2,["\n                "])),(n()(),a._31(13,0,null,3,5,"core-rich-text-editor",[["formControlName","content"],["item-content",""],["name","content"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,$.b,$.a)),a._30(14,1228800,null,0,nn.a,[b.a,tn.a,m.a,ln.a,[2,en.a],a.t,f.a,K.a,on.a],{placeholder:[0,"placeholder"],control:[1,"control"],name:[2,"name"],component:[3,"component"],componentId:[4,"componentId"]},null),a._47(131072,Z.a,[J.a,a.j]),a._30(16,671744,null,0,h.f,[[3,h.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),a._50(2048,null,h.m,null,[h.f]),a._30(18,16384,null,0,h.n,[h.m],null,null),(n()(),a._55(-1,2,["\n            "]))],function(n,t){var l=t.component;n(t,8,0,l.textRequired);n(t,14,0,a._56(t,14,0,a._44(t,15).transform("addon.mod_workshop.submissioncontent")),l.editForm.controls.content,"content",l.component,l.componentId);n(t,16,0,"content")},function(n,t){n(t,10,0,a._56(t,10,0,a._44(t,11).transform("addon.mod_workshop.submissioncontent")));n(t,13,0,a._44(t,18).ngClassUntouched,a._44(t,18).ngClassTouched,a._44(t,18).ngClassPristine,a._44(t,18).ngClassDirty,a._44(t,18).ngClassValid,a._44(t,18).ngClassInvalid,a._44(t,18).ngClassPending)})}function i(n){return a._57(0,[(n()(),a._31(0,0,null,null,1,"core-attachments",[["allowOffline","true"]],null,null,null,sn.b,sn.a)),a._30(1,114688,null,0,an.a,[un.a,b.a,g.a,v.a,J.a,rn.a],{files:[0,"files"],maxSize:[1,"maxSize"],maxSubmissions:[2,"maxSubmissions"],component:[3,"component"],componentId:[4,"componentId"],allowOffline:[5,"allowOffline"],acceptedTypes:[6,"acceptedTypes"],required:[7,"required"]},null)],function(n,t){var l=t.component;n(t,1,0,l.submission.attachmentfiles,l.workshop.maxbytes,l.workshop.nattachments,l.component,l.workshop.coursemodule,"true",l.workshop.submissionfiletypes,l.fileRequired)},null)}function o(n){return a._57(0,[(n()(),a._31(0,0,null,null,32,"form",[["ion-list",""],["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"submit"],[null,"reset"]],function(n,t,l){var e=!0;if("submit"===t){e=!1!==a._44(n,2).onSubmit(l)&&e}if("reset"===t){e=!1!==a._44(n,2).onReset()&&e}return e},null,null)),a._30(1,16384,null,0,h.w,[],null,null),a._30(2,540672,null,0,h.h,[[8,null],[8,null]],{form:[0,"form"]},null),a._50(2048,null,h.b,null,[h.h]),a._30(4,16384,null,0,h.o,[h.b],null,null),(n()(),a._55(-1,null,["\n            "])),(n()(),a._31(6,0,null,null,19,"ion-item",[["class","item item-block"],["text-wrap",""]],null,null,null,N.b,N.a)),a._30(7,1097728,null,3,B.a,[H.a,Y.a,a.t,a.V,[2,z.a]],null,null),a._52(335544320,2,{contentLabel:0}),a._52(603979776,3,{_buttons:1}),a._52(603979776,4,{_icons:1}),a._30(11,16384,null,0,G.a,[],null,null),(n()(),a._55(-1,2,["\n                "])),(n()(),a._31(13,0,null,1,4,"ion-label",[["core-mark-required","true"],["stacked",""]],null,null,null,Q.b,Q.a)),a._30(14,4308992,null,0,W.a,[a.t,J.a,g.a,K.a],{coreMarkRequired:[0,"coreMarkRequired"]},null),a._30(15,16384,[[2,4]],0,X.a,[Y.a,a.t,a.V,[8,null],[8,""],[8,null],[8,null]],null,null),(n()(),a._55(16,0,["",""])),a._47(131072,Z.a,[J.a,a.j]),(n()(),a._55(-1,2,["\n                "])),(n()(),a._31(19,0,null,3,5,"ion-input",[["formControlName","title"],["name","title"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,dn.b,dn.a)),a._30(20,671744,null,0,h.f,[[3,h.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),a._50(2048,null,h.m,null,[h.f]),a._30(22,16384,null,0,h.n,[h.m],null,null),a._30(23,5423104,null,0,cn.a,[Y.a,on.a,H.a,hn.a,a.t,a.V,[2,en.a],[2,B.a],[2,h.m],fn.a],{type:[0,"type"],placeholder:[1,"placeholder"]},null),a._47(131072,Z.a,[J.a,a.j]),(n()(),a._55(-1,2,["\n            "])),(n()(),a._55(-1,null,["\n\n            "])),(n()(),a._26(16777216,null,null,1,null,e)),a._30(28,16384,null,0,mn.k,[a._11,a._6],{ngIf:[0,"ngIf"]},null),(n()(),a._55(-1,null,["\n\n            "])),(n()(),a._26(16777216,null,null,1,null,i)),a._30(31,16384,null,0,mn.k,[a._11,a._6],{ngIf:[0,"ngIf"]},null),(n()(),a._55(-1,null,["\n        "]))],function(n,t){var l=t.component;n(t,2,0,l.editForm);n(t,14,0,"true");n(t,20,0,"title");n(t,23,0,"text",a._56(t,23,1,a._44(t,24).transform("addon.mod_workshop.submissiontitle")));n(t,28,0,l.textAvailable);n(t,31,0,l.fileAvailable)},function(n,t){n(t,0,0,a._44(t,4).ngClassUntouched,a._44(t,4).ngClassTouched,a._44(t,4).ngClassPristine,a._44(t,4).ngClassDirty,a._44(t,4).ngClassValid,a._44(t,4).ngClassInvalid,a._44(t,4).ngClassPending);n(t,16,0,a._56(t,16,0,a._44(t,17).transform("addon.mod_workshop.submissiontitle")));n(t,19,0,a._44(t,22).ngClassUntouched,a._44(t,22).ngClassTouched,a._44(t,22).ngClassPristine,a._44(t,22).ngClassDirty,a._44(t,22).ngClassValid,a._44(t,22).ngClassInvalid,a._44(t,22).ngClassPending)})}function s(n){return a._57(0,[(n()(),a._31(0,0,null,null,23,"ion-header",[],null,null,null,null,null)),a._30(1,16384,null,0,_n.a,[Y.a,a.t,a.V,[2,pn.a]],null,null),(n()(),a._55(-1,null,["\n    "])),(n()(),a._31(3,0,null,null,19,"ion-navbar",[["class","toolbar"],["core-back-button",""]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,bn.b,bn.a)),a._30(4,49152,null,0,gn.a,[hn.a,[2,pn.a],[2,vn.a],Y.a,a.t,a.V],null,null),a._30(5,212992,null,0,kn.a,[gn.a,on.a,J.a,f.a],null,null),(n()(),a._55(-1,3,["\n        "])),(n()(),a._31(7,0,null,3,3,"ion-title",[],null,null,null,wn.b,wn.a)),a._30(8,49152,null,0,In.a,[Y.a,a.t,a.V,[2,yn.a],[2,gn.a]],null,null),(n()(),a._55(9,0,["",""])),a._47(131072,Z.a,[J.a,a.j]),(n()(),a._55(-1,3,["\n        "])),(n()(),a._31(12,0,null,2,9,"ion-buttons",[["end",""]],null,null,null,null,null)),a._30(13,16384,null,1,Sn.a,[Y.a,a.t,a.V,[2,yn.a],[2,gn.a]],null,null),a._52(603979776,1,{_buttons:1}),(n()(),a._55(-1,null,["\n            "])),(n()(),a._31(16,0,null,null,4,"button",[["clear",""],["ion-button",""]],[[1,"aria-label",0]],[[null,"click"]],function(n,t,l){var e=!0;if("click"===t){e=!1!==n.component.save()&&e}return e},Pn.b,Pn.a)),a._30(17,1097728,[[1,4]],0,Cn.a,[[8,""],Y.a,a.t,a.V],{clear:[0,"clear"]},null),a._47(131072,Z.a,[J.a,a.j]),(n()(),a._55(19,0,["\n                ","\n            "])),a._47(131072,Z.a,[J.a,a.j]),(n()(),a._55(-1,null,["\n        "])),(n()(),a._55(-1,3,["\n    "])),(n()(),a._55(-1,null,["\n"])),(n()(),a._55(-1,null,["\n"])),(n()(),a._31(25,0,null,null,9,"ion-content",[],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,Dn.b,Dn.a)),a._30(26,4374528,null,0,en.a,[Y.a,on.a,fn.a,a.t,a.V,hn.a,On.a,a.M,[2,pn.a],[2,vn.a]],null,null),(n()(),a._55(-1,1,["\n    "])),(n()(),a._31(28,0,null,1,5,"core-loading",[],null,null,null,Rn.b,Rn.a)),a._30(29,638976,null,0,Un.a,[J.a,a.t,f.a,K.a],{hideUntil:[0,"hideUntil"]},null),(n()(),a._55(-1,0,["\n        "])),(n()(),a._26(16777216,null,0,1,null,o)),a._30(32,16384,null,0,mn.k,[a._11,a._6],{ngIf:[0,"ngIf"]},null),(n()(),a._55(-1,0,["\n    "])),(n()(),a._55(-1,1,["\n"])),(n()(),a._55(-1,null,["\n"]))],function(n,t){var l=t.component;n(t,5,0);n(t,17,0,"");n(t,29,0,l.loaded);n(t,32,0,l.workshop)},function(n,t){n(t,3,0,a._44(t,4)._hidden,a._44(t,4)._sbPadding);n(t,9,0,a._56(t,9,0,a._44(t,10).transform("addon.mod_workshop.editsubmission")));n(t,16,0,a._56(t,16,0,a._44(t,18).transform("core.save")));n(t,19,0,a._56(t,19,0,a._44(t,20).transform("core.save")));n(t,25,0,a._44(t,26).statusbarPadding,a._44(t,26)._hasRefresher)})}Object.defineProperty(t,"__esModule",{value:!0});var a=l(0),u=l(5),r=l(3),d=l(27),c=l(31),h=l(23),f=l(10),m=l(1),_=l(81),p=l(178),b=l(4),g=l(11),v=l(73),k=l(176),w=l(204),I=l(190),y=this&&this.__decorate||function(n,t,l,e){var i,o=arguments.length,s=o<3?t:null===e?e=Object.getOwnPropertyDescriptor(t,l):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(n,t,l,e);else for(var a=n.length-1;a>=0;a--)(i=n[a])&&(s=(o<3?i(s):o>3?i(t,l,s):i(t,l))||s);return o>3&&s&&Object.defineProperty(t,l,s),s},S=this&&this.__metadata||function(n,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(n,t)},P=function(){function n(n,t,l,e,i,o,s,a,u,r,d,c,f,m){this.fileUploaderProvider=l,this.workshopProvider=e,this.workshopOffline=i,this.workshopHelper=o,this.navCtrl=s,this.fileSessionprovider=a,this.syncProvider=u,this.textUtils=r,this.domUtils=d,this.fb=c,this.translate=f,this.eventsProvider=m,this.submission={id:0,title:"",content:"",attachmentfiles:[]},this.loaded=!1,this.component=k.a.COMPONENT,this.originalData={},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.module=n.get("module"),this.courseId=n.get("courseId"),this.access=n.get("access"),this.submissionId=n.get("submissionId"),this.workshopId=this.module.instance,this.componentId=this.module.id,this.userId=t.getCurrentSiteUserId(),this.siteId=t.getCurrentSiteId(),this.editForm=new h.g({}),this.editForm.addControl("title",this.fb.control("",h.u.required)),this.editForm.addControl("content",this.fb.control(""))}return n.prototype.ngOnInit=function(){this.isDestroyed||this.syncProvider.blockOperation(this.component,this.workshopId),this.fetchSubmissionData()},n.prototype.ionViewCanLeave=function(){var n=this;if(this.forceLeave)return!0;return(this.hasDataChanged()?this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")):Promise.resolve()).then(function(){n.submission.attachmentfiles&&n.fileUploaderProvider.clearTmpFiles(n.submission.attachmentfiles)})},n.prototype.fetchSubmissionData=function(){var n=this;return this.workshopProvider.getWorkshop(this.courseId,this.module.id).then(function(t){if(n.workshop=t,n.textAvailable=n.workshop.submissiontypetext!=k.a.SUBMISSION_TYPE_DISABLED,n.textRequired=n.workshop.submissiontypetext==k.a.SUBMISSION_TYPE_REQUIRED,n.fileAvailable=n.workshop.submissiontypefile!=k.a.SUBMISSION_TYPE_DISABLED,n.fileRequired=n.workshop.submissiontypefile==k.a.SUBMISSION_TYPE_REQUIRED,n.editForm.controls.content.setValidators(n.textRequired?h.u.required:null),n.submissionId>0)return n.editing=!0,n.workshopHelper.getSubmissionById(n.workshopId,n.submissionId).then(function(t){n.submission=t;n.userId==t.authorid&&n.access.cansubmit&&n.access.modifyingsubmissionallowed||n.forceLeavePage()});n.access.cansubmit&&n.access.creatingsubmissionallowed||n.forceLeavePage()}).then(function(){return n.workshopOffline.getSubmissions(n.workshopId).then(function(t){if(t&&t.length){n.hasOffline=!0;var l=n.workshopHelper.filterSubmissionActions(t,n.editing?n.submission.id:0);return n.workshopHelper.applyOfflineData(n.submission,l)}n.hasOffline=!1}).finally(function(){n.originalData.title=n.submission.title,n.originalData.content=n.submission.content,n.originalData.attachmentfiles=[],n.submission.attachmentfiles.forEach(function(t){var l;l=t.filename?t.filename:"/"==t.filepath[0]?t.filepath.substr(1):t.filepath,n.originalData.attachmentfiles.push({filename:l,fileurl:t.fileurl})})})}).then(function(){n.editForm.controls.title.setValue(n.submission.title),n.editForm.controls.content.setValue(n.submission.content);n.fileSessionprovider.setFiles(n.component,n.workshopId+"_"+(n.submission.id||"newsub"),n.submission.attachmentfiles||[]),n.loaded=!0}).catch(function(t){n.loaded=!1,n.domUtils.showErrorModalDefault(t,"core.course.errorgetmodule",!0),n.forceLeavePage()})},n.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},n.prototype.getInputData=function(){var n=this.submission.id||"newsub",t={title:this.editForm.value.title,content:null,attachmentfiles:[]};return this.textAvailable&&(t.content=this.editForm.value.content||""),this.fileAvailable&&(t.attachmentfiles=this.fileSessionprovider.getFiles(this.component,this.workshopId+"_"+n)||[]),t},n.prototype.hasDataChanged=function(){if(!this.loaded)return!1;var n=this.getInputData();return!(!this.originalData||void 0===this.originalData.title)&&(!!(this.originalData.title!=n.title||this.textAvailable&&this.originalData.content!=n.content)||!!this.fileAvailable&&this.fileUploaderProvider.areFileListDifferent(n.attachmentfiles,this.originalData.attachmentfiles))},n.prototype.save=function(){var n=this;this.hasDataChanged()?this.saveSubmission().then(function(){n.forceLeavePage()}).catch(function(){}):this.forceLeavePage()},n.prototype.saveSubmission=function(){var n=this,t=this.getInputData();if(!t.title)return this.domUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredtitle"),Promise.reject(null);var l=this.textUtils.htmlIsBlank(t.content),e=!t.attachmentfiles.length;if(this.textRequired&&l||this.fileRequired&&e||l&&e)return this.domUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredcontent"),Promise.reject(null);var i=!0,o=!1,s=this.domUtils.showModalLoading("core.sending",!0),a=this.submission.id;return this.textAvailable&&(t.content=this.textUtils.formatHtmlLines(t.content)),i=!t.attachmentfiles.length,this.workshopHelper.uploadOrStoreSubmissionFiles(this.workshopId,this.submission.id,t.attachmentfiles,this.editing,o).catch(function(){return o=!0,i=!0,n.workshopHelper.uploadOrStoreSubmissionFiles(n.workshopId,n.submission.id,t.attachmentfiles,n.editing,o)}).then(function(l){return o||n.fileAvailable||(l=null),n.editing?o?n.workshopOffline.saveSubmission(n.workshopId,n.courseId,t.title,t.content,l,a,"update").then(function(){}):n.workshopProvider.updateSubmission(n.workshopId,a,n.courseId,t.title,t.content,l,void 0,i):o?n.workshopOffline.saveSubmission(n.workshopId,n.courseId,t.title,t.content,l,a,"add").then(function(){}):n.workshopProvider.addSubmission(n.workshopId,n.courseId,t.title,t.content,l,void 0,a,i)}).then(function(l){var e={workshopId:n.workshopId,cmId:n.module.cmid};l&&a&&(n.workshopOffline.deleteSubmissionAction(n.workshopId,a,n.editing?"update":"add"),n.workshopHelper.deleteSubmissionStoredFiles(n.workshopId,a,n.editing),e.submissionId=l);return(l?n.workshopProvider.invalidateSubmissionData(n.workshopId,l):Promise.resolve()).finally(function(){n.eventsProvider.trigger(k.a.SUBMISSION_CHANGED,e,n.siteId),n.fileUploaderProvider.clearTmpFiles(t.attachmentfiles)})}).catch(function(t){n.domUtils.showErrorModalDefault(t,"Cannot save submission")}).finally(function(){s.dismiss()})},n.prototype.ngOnDestroy=function(){this.isDestroyed=!0,this.syncProvider.unblockOperation(this.component,this.workshopId)},n=y([Object(a.m)({selector:"page-addon-mod-workshop-edit-submission",templateUrl:"edit-submission.html"}),S("design:paramtypes",[u.t,m.a,v.a,k.a,I.a,w.a,u.s,p.a,_.a,g.a,b.a,h.d,r.c,f.a])],n)}(),C=this&&this.__decorate||function(n,t,l,e){var i,o=arguments.length,s=o<3?t:null===e?e=Object.getOwnPropertyDescriptor(t,l):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(n,t,l,e);else for(var a=n.length-1;a>=0;a--)(i=n[a])&&(s=(o<3?i(s):o>3?i(t,l,s):i(t,l))||s);return o>3&&s&&Object.defineProperty(t,l,s),s},D=function(){function n(){}return n=C([Object(a.I)({declarations:[P],imports:[c.a,d.a,u.l.forChild(P),r.b.forChild()]})],n)}(),O=l(1528),R=l(1529),U=l(1530),x=l(1531),q=l(1532),A=l(1533),j=l(1534),F=l(1535),V=l(1536),L=l(1537),M=l(1538),E=l(1539),T=l(1540),N=l(30),B=l(20),H=l(19),Y=l(8),z=l(26),G=l(33),Q=l(95),W=l(85),J=l(17),K=l(2),X=l(67),Z=l(25),$=l(318),nn=l(253),tn=l(22),ln=l(18),en=l(29),on=l(16),sn=l(487),an=l(319),un=l(9),rn=l(150),dn=l(112),cn=l(92),hn=l(35),fn=l(34),mn=l(7),_n=l(375),pn=l(39),bn=l(727),gn=l(213),vn=l(21),kn=l(479),wn=l(728),In=l(316),yn=l(250),Sn=l(376),Pn=l(45),Cn=l(41),Dn=l(182),On=l(109),Rn=l(54),Un=l(51),xn=l(70),qn=a._29({encapsulation:2,styles:[],data:{}}),An=a._27("page-addon-mod-workshop-edit-submission",P,function(n){return a._57(0,[(n()(),a._31(0,0,null,null,1,"page-addon-mod-workshop-edit-submission",[],null,null,null,s,qn)),a._30(1,245760,null,0,P,[xn.a,m.a,v.a,k.a,I.a,w.a,vn.a,p.a,_.a,g.a,b.a,h.d,J.a,f.a],null,null)],function(n,t){n(t,1,0)},null)},{},{},[]),jn=l(371),Fn=l(372),Vn=l(374),Ln=l(373),Mn=l(478),En=l(726),Tn=l(108),Nn=l(273);l.d(t,"AddonModWorkshopEditSubmissionPageModuleNgFactory",function(){return Bn});var Bn=a._28(D,[],function(n){return a._40([a._41(512,a.o,a._21,[[8,[O.a,R.a,U.a,x.a,q.a,A.a,j.a,F.a,V.a,L.a,M.a,E.a,T.a,An]],[3,a.o],a.K]),a._41(4608,mn.m,mn.l,[a.G,[2,mn.w]]),a._41(4608,h.x,h.x,[]),a._41(4608,h.d,h.d,[]),a._41(4608,jn.b,jn.a,[]),a._41(4608,Fn.a,Fn.b,[]),a._41(4608,Vn.b,Vn.a,[]),a._41(4608,Ln.b,Ln.a,[]),a._41(4608,J.a,J.a,[Mn.a,jn.b,Fn.a,Vn.b,Ln.b,J.b,J.c]),a._41(512,c.a,c.a,[]),a._41(512,mn.b,mn.b,[]),a._41(512,h.v,h.v,[]),a._41(512,h.i,h.i,[]),a._41(512,h.s,h.s,[]),a._41(512,En.a,En.a,[]),a._41(512,r.b,r.b,[]),a._41(512,Tn.a,Tn.a,[]),a._41(512,d.a,d.a,[]),a._41(512,En.b,En.b,[]),a._41(512,D,D,[]),a._41(256,J.c,void 0,[]),a._41(256,J.b,void 0,[]),a._41(256,Nn.a,P,[])])})}});